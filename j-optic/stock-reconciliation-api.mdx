---
title: "Stock Reconciliation API"
description: "Create and retrieve stock reconciliation records for inventory management with system vs actual quantity tracking"
---

# Stock Reconciliation API Documentation

This document describes the stock reconciliation endpoints for managing inventory reconciliation records in the optical store system. Stock reconciliation allows you to compare system quantities with actual physical counts and automatically adjust inventory discrepancies.

## Endpoint Details

**Base URL:** `https://joptic.jethings.com`

### Required Headers

```
x-store-id: <store_id>
Authorization: Bearer <token>
```

---

## Authentication

All endpoints require user authentication. The user ID is extracted from the JWT token (`req.user.sub`), and store access is validated via the `@StoreId()` decorator. Users must have an active relation with the store to access stock reconciliations.

---

## Get All Stock Reconciliations

Retrieve a paginated list of stock reconciliation records for the current store.

**Endpoint:** `GET /stock-reconciliation`

### Query Parameters

| Parameter   | Type      | Required | Default     | Description                          |
|-------------|-----------|----------|-------------|--------------------------------------|
| `search`    | `string`  | No       | —           | Search term to filter reconciliations by note |
| `page`      | `number`  | No       | `1`         | Page number (min: 1)                 |
| `limit`     | `number`  | No       | `10`        | Items per page (min: 1, max: 100)    |
| `sortBy`    | `string`  | No       | `createdAt` | Field to sort by                     |
| `sortOrder` | `string`  | No       | `desc`      | Sort order: "asc" or "desc"          |

**Sort By Options:**
- `id` - Reconciliation ID
- `systemQty` - System quantity
- `actualQty` - Actual quantity
- `differenceQty` - Difference quantity
- `createdAt` - Creation date (default)
- `updatedAt` - Last update date

### Success Response

```json
{
  "data": [
    {
      "id": "reconciliation_123",
      "note": "Monthly inventory check - Warehouse A",
      "systemQty": "100.00",
      "actualQty": "98.50",
      "differenceQty": "-1.50",
      "createdAt": "2024-01-15T10:30:00.000Z",
      "updatedAt": "2024-01-15T10:30:00.000Z"
    },
    {
      "id": "reconciliation_124",
      "note": "Quarterly audit - Lens inventory",
      "systemQty": "250.00",
      "actualQty": "252.00",
      "differenceQty": "2.00",
      "createdAt": "2024-01-14T09:20:00.000Z",
      "updatedAt": "2024-01-14T09:20:00.000Z"
    }
  ],
  "pagination": {
    "page": 1,
    "limit": 10,
    "total": 25,
    "totalPages": 3,
    "hasNext": true,
    "hasPrev": false
  }
}
```

### Response Fields

- `id` (string) - Unique identifier for the reconciliation record
- `note` (string | null) - Optional note about the reconciliation
- `systemQty` (string) - System quantity at the time of reconciliation (from active bins)
- `actualQty` (string) - Actual physical quantity counted
- `differenceQty` (string) - Difference between actual and system quantity (actualQty - systemQty)
- `createdAt` (Date) - Timestamp when the reconciliation was created
- `updatedAt` (Date) - Timestamp when the reconciliation was last updated

<Note>
  Results are paginated for performance. Search is case-insensitive and matches reconciliation notes. Default sorting is by creation date (newest first). Only reconciliations for warehouses belonging to the authenticated user's store are returned.
</Note>

### Example Request

<CodeGroup>
```bash cURL
curl -X GET "https://joptic.jethings.com/stock-reconciliation?search=monthly&page=1&limit=20&sortBy=createdAt&sortOrder=desc" \
  -H "x-store-id: your-store-id" \
  -H "Authorization: Bearer <token>"
```

```javascript JavaScript
const params = new URLSearchParams({
  search: "monthly",
  page: "1",
  limit: "20",
  sortBy: "createdAt",
  sortOrder: "desc"
})

const response = await fetch(`https://joptic.jethings.com/stock-reconciliation?${params}`, {
  method: "GET",
  headers: {
    "x-store-id": "your-store-id",
    Authorization: "Bearer <token>",
  },
})

const result = await response.json()
```

```python Python
import requests

url = "https://joptic.jethings.com/stock-reconciliation"

params = {
    "search": "monthly",
    "page": 1,
    "limit": 20,
    "sortBy": "createdAt",
    "sortOrder": "desc"
}

response = requests.get(
    url,
    headers={
        "x-store-id": "your-store-id",
        "Authorization": "Bearer <token>"
    },
    params=params
)

print(response.json())
```
</CodeGroup>

### Possible Errors

- `401 Unauthorized` - Missing or invalid authentication token
- `403 Forbidden` - User does not have access to the store
- `500 Internal Server Error` - Server error

---

## Create Stock Reconciliation

Create a new stock reconciliation record. The system automatically calculates the current system quantity from active bins, compares it with the provided actual quantity, and queues a background job to update the Stock Ledger Entry (SLE) and bin quantities.

**Endpoint:** `POST /stock-reconciliation`

### Request Body

| Field         | Type      | Required | Description                                    |
|---------------|-----------|----------|------------------------------------------------|
| `warehouse`   | `string`  | ✅ Yes   | ID of the warehouse where reconciliation is performed |
| `itemVariant` | `string`  | ✅ Yes   | ID of the item variant being reconciled        |
| `actualQty`   | `number`  | ✅ Yes   | Actual physical quantity counted               |
| `note`        | `string`  | No       | Optional note about the reconciliation         |

### Request Body Example

```json
{
  "warehouse": "warehouse_123",
  "itemVariant": "item_variant_456",
  "actualQty": 98.5,
  "note": "Monthly inventory check - Found 1.5 units missing"
}
```

### Success Response

```json
{
  "id": "reconciliation_789",
  "warehouse": "warehouse_123",
  "itemVariant": "item_variant_456",
  "systemQty": "100.00",
  "actualQty": "98.50",
  "differenceQty": "-1.50",
  "note": "Monthly inventory check - Found 1.5 units missing",
  "createdAt": "2024-01-15T10:30:00.000Z",
  "updatedAt": "2024-01-15T10:30:00.000Z"
}
```

### Response Fields

- `id` (string) - Unique identifier for the created reconciliation record
- `warehouse` (string) - ID of the warehouse
- `itemVariant` (string) - ID of the item variant
- `systemQty` (string) - System quantity calculated from active bins
- `actualQty` (string) - Actual quantity provided in the request
- `differenceQty` (string) - Calculated difference (actualQty - systemQty)
- `note` (string | null) - Note provided in the request
- `createdAt` (Date) - Timestamp when the reconciliation was created
- `updatedAt` (Date) - Timestamp when the reconciliation was last updated

### Example Request

<CodeGroup>
```bash cURL
curl -X POST https://joptic.jethings.com/stock-reconciliation \
  -H "x-store-id: your-store-id" \
  -H "Authorization: Bearer <token>" \
  -H "Content-Type: application/json" \
  -d '{
    "warehouse": "warehouse_123",
    "itemVariant": "item_variant_456",
    "actualQty": 98.5,
    "note": "Monthly inventory check - Found 1.5 units missing"
  }'
```

```javascript JavaScript
const reconciliationData = {
  warehouse: "warehouse_123",
  itemVariant: "item_variant_456",
  actualQty: 98.5,
  note: "Monthly inventory check - Found 1.5 units missing"
}

const response = await fetch("https://joptic.jethings.com/stock-reconciliation", {
  method: "POST",
  headers: {
    "x-store-id": "your-store-id",
    Authorization: "Bearer <token>",
    "Content-Type": "application/json",
  },
  body: JSON.stringify(reconciliationData),
})

const result = await response.json()
```

```python Python
import requests

url = "https://joptic.jethings.com/stock-reconciliation"

reconciliation_data = {
    "warehouse": "warehouse_123",
    "itemVariant": "item_variant_456",
    "actualQty": 98.5,
    "note": "Monthly inventory check - Found 1.5 units missing"
}

response = requests.post(
    url,
    headers={
        "x-store-id": "your-store-id",
        "Authorization": "Bearer <token>",
        "Content-Type": "application/json"
    },
    json=reconciliation_data
)

print(response.json())
```
</CodeGroup>

<Note>
  When a reconciliation is created, the system automatically:
  1. Calculates the current system quantity from active bins for the specified warehouse and item variant
  2. Calculates the difference (actualQty - systemQty)
  3. Creates the reconciliation record
  4. Queues a background job to update the Stock Ledger Entry (SLE) and bin quantities
  
  The background job processes the reconciliation asynchronously, so inventory updates may not be immediate. Positive differences indicate stock gains, while negative differences indicate stock losses.
</Note>

### Possible Errors

- `400 Bad Request` - Validation errors (missing required fields, invalid data types)
- `401 Unauthorized` - Missing or invalid authentication token
- `403 Forbidden` - User does not have access to the store
- `500 Internal Server Error` - Server error

---

## Business Logic

### Stock Reconciliation Process

Stock reconciliation is a critical inventory management process that compares system-recorded quantities with actual physical counts. Here's how it works:

<AccordionGroup>
  <Accordion title="System Quantity Calculation" icon="calculator">
    **System Quantity Calculation**
    
    When creating a reconciliation, the system automatically calculates the current system quantity by:
    1. Querying all active bins (`isActive = true`) for the specified warehouse and item variant
    2. Summing the quantities from all active bins
    3. Using `COALESCE` to return 0 if no active bins exist
    
    This ensures the reconciliation is based on the most current system state.
  </Accordion>

  <Accordion title="Difference Calculation" icon="trending-up">
    **Difference Calculation**
    
    The difference is calculated as:
    ```
    differenceQty = actualQty - systemQty
    ```
    
    - **Positive difference** (actualQty > systemQty): Indicates stock gain (e.g., found items not recorded)
    - **Negative difference** (actualQty < systemQty): Indicates stock loss (e.g., missing items, damage, theft)
    - **Zero difference**: Perfect match between system and physical count
  </Accordion>

  <Accordion title="Background Processing" icon="sync">
    **Background Job Processing**
    
    After creating a reconciliation record, the system queues a background job that:
    1. Updates the Stock Ledger Entry (SLE) with the reconciliation transaction
    2. Adjusts bin quantities to match the actual quantity
    3. Maintains audit trail for inventory adjustments
    
    This asynchronous processing ensures the API responds quickly while maintaining data integrity.
  </Accordion>

  <Accordion title="Store Access Validation" icon="shield">
    **Store Access Validation**
    
    Before processing any reconciliation:
    1. The system validates the user has an active relation with the store
    2. Only reconciliations for warehouses belonging to the user's accessible stores are returned
    3. This prevents unauthorized access to inventory data across stores
  </Accordion>
</AccordionGroup>

### Reconciliation States

<CardGroup cols={2}>
  <Card title="Positive Difference" icon="arrow-up">
    **Stock Gain** (`differenceQty > 0`)
    <br/>
    Physical count exceeds system count. May indicate unrecorded receipts or counting errors.
  </Card>

  <Card title="Negative Difference" icon="arrow-down">
    **Stock Loss** (`differenceQty < 0`)
    <br/>
    System count exceeds physical count. May indicate theft, damage, or counting errors.
  </Card>

  <Card title="Zero Difference" icon="check-circle">
    **Perfect Match** (`differenceQty = 0`)
    <br/>
    System and physical counts match exactly. Ideal reconciliation result.
  </Card>

  <Card title="Reconciliation Record" icon="file-text">
    **Audit Trail**
    <br/>
    All reconciliations are permanently recorded with timestamps for compliance and auditing purposes.
  </Card>
</CardGroup>

---

## Error Responses

All endpoints may return standard HTTP error codes:

- `400 Bad Request` - Invalid request parameters or body
- `401 Unauthorized` - Missing or invalid authentication token
- `403 Forbidden` - User does not have access to the store
- `500 Internal Server Error` - Server error

### Error Response Format

```json
{
  "statusCode": 403,
  "message": "You do not have access to this store",
  "error": "Forbidden"
}
```

### Common Error Scenarios

**403 Forbidden - Store Access**
```json
{
  "statusCode": 403,
  "message": "You do not have access to this store"
}
```
Occurs when the user doesn't have an active relation with the specified store.

**400 Bad Request - Validation Error**
```json
{
  "statusCode": 400,
  "message": ["warehouse must be a string", "actualQty must be a number"],
  "error": "Bad Request"
}
```
Occurs when required fields are missing or data types are incorrect.

---

## Usage Examples

### Example 1: Get all reconciliations with pagination

<CodeGroup>
```bash cURL
curl -X GET "https://joptic.jethings.com/stock-reconciliation?page=1&limit=10" \
  -H "x-store-id: your-store-id" \
  -H "Authorization: Bearer <token>"
```
</CodeGroup>

### Example 2: Search reconciliations by note

<CodeGroup>
```bash cURL
curl -X GET "https://joptic.jethings.com/stock-reconciliation?search=monthly&page=1&limit=20" \
  -H "x-store-id: your-store-id" \
  -H "Authorization: Bearer <token>"
```
</CodeGroup>

### Example 3: Create a reconciliation for stock loss

<CodeGroup>
```bash cURL
curl -X POST https://joptic.jethings.com/stock-reconciliation \
  -H "x-store-id: your-store-id" \
  -H "Authorization: Bearer <token>" \
  -H "Content-Type: application/json" \
  -d '{
    "warehouse": "warehouse_123",
    "itemVariant": "item_variant_456",
    "actualQty": 95.0,
    "note": "Quarterly audit - Found 5 units missing, investigating"
  }'
```
</CodeGroup>

### Example 4: Create a reconciliation for stock gain

<CodeGroup>
```bash cURL
curl -X POST https://joptic.jethings.com/stock-reconciliation \
  -H "x-store-id: your-store-id" \
  -H "Authorization: Bearer <token>" \
  -H "Content-Type: application/json" \
  -d '{
    "warehouse": "warehouse_123",
    "itemVariant": "item_variant_456",
    "actualQty": 102.0,
    "note": "Found unrecorded items from previous shipment"
  }'
```
</CodeGroup>

### Example 5: Sort reconciliations by difference quantity

<CodeGroup>
```bash cURL
curl -X GET "https://joptic.jethings.com/stock-reconciliation?sortBy=differenceQty&sortOrder=asc&limit=20" \
  -H "x-store-id: your-store-id" \
  -H "Authorization: Bearer <token>"
```
</CodeGroup>

---

## Best Practices

<AccordionGroup>
  <Accordion title="Reconciliation Frequency">
    - Perform regular reconciliations (monthly or quarterly) to maintain inventory accuracy
    - Reconcile high-value items more frequently
    - Document reasons for discrepancies in the note field
  </Accordion>

  <Accordion title="Note Documentation">
    - Always include descriptive notes explaining the reconciliation context
    - Document reasons for discrepancies (theft, damage, counting errors, etc.)
    - Include date and person performing the reconciliation in notes
  </Accordion>

  <Accordion title="Pagination">
    - Use pagination when fetching large lists of reconciliations
    - Default limit of 10 is suitable for most use cases
    - Maximum limit of 100 should be used sparingly
  </Accordion>

  <Accordion title="Error Handling">
    - Always check for 403 errors when accessing store data
    - Handle validation errors (400) by checking the error message array
    - Implement retry logic for 500 errors with exponential backoff
  </Accordion>

  <Accordion title="Background Processing">
    - Understand that inventory updates happen asynchronously
    - Don't expect immediate quantity updates after creating a reconciliation
    - Monitor the reconciliation record to track processing status
  </Accordion>

  <Accordion title="Data Accuracy">
    - Double-check actual quantities before submitting reconciliations
    - Verify warehouse and item variant IDs are correct
    - Review system quantities before reconciliation to understand expected differences
  </Accordion>
</AccordionGroup>

---

## Related Endpoints

Stock reconciliation works in conjunction with other inventory management endpoints:

- **Warehouse Management** - Manage warehouses where reconciliations are performed
- **Item Variant Management** - Manage item variants that are being reconciled
- **Stock Ledger Entry (SLE)** - View detailed stock transaction history
- **Bin Management** - View and manage bin quantities that are reconciled

<Info>
  Stock reconciliation automatically updates the Stock Ledger Entry and bin quantities through background processing. You don't need to manually update these after creating a reconciliation.
</Info>

---

## Summary

| Endpoint                      | Method | Description                                       |
| ----------------------------- | ------ | ------------------------------------------------- |
| `/stock-reconciliation`       | `GET`  | Retrieve paginated list of stock reconciliations  |
| `/stock-reconciliation`       | `POST` | Create a new stock reconciliation record         |

---

<CardGroup cols={2}>
  <Card
    title="Item API"
    icon="package"
    href="/j-optic/item-api"
  >
    Create and manage optical items
  </Card>
  <Card
    title="Price List API"
    icon="tag"
    href="/j-optic/price-list-api"
  >
    Manage price lists for items
  </Card>
</CardGroup>

